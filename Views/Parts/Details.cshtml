@model AutoPartsWeb.Models.Part
@using AutoPartsWeb.Models
@{
    ViewData["Title"] = Model.Name;
    var compat = Model.PartVehicles?.Select(pv => pv.Vehicle).Where(v => v != null).ToList() ?? new();
    var gallery = Model.PartImages?.OrderBy(pi => pi.SortOrder).ToList() ?? new List<PartImage>();
    var reviews = ViewBag.Reviews as List<ProductReview> ?? new();
    double avgRating = ViewBag.AvgRating is double d ? d : 0;
    var questions = ViewBag.Questions as List<ProductQuestion> ?? new();
    var similarReviewDict = ViewBag.SimilarReviews as Dictionary<int, (double avg, int count)> ?? new();
    var discoverReviewDict = ViewBag.DiscoverReviews as Dictionary<int, (double avg, int count)> ?? new();
}

<div class="container py-4">
    <div class="row g-4">
        <div class="col-lg-5">
            @{
                var slides = new List<string>();
                if (!string.IsNullOrWhiteSpace(Model.ImageUrl)) slides.Add(Model.ImageUrl);
                slides.AddRange(gallery.Select(g => g.Url));
                if (slides.Count == 0) slides.Add(Url.Content("~/images/logo.png"));
            }
            <div class="d-flex align-items-start gap-3">
                <div class="d-flex flex-column gap-2" style="width:90px;">
                    @for (int i = 0; i < slides.Count; i++)
                    {
                        var activeThumb = i == 0 ? "border border-2 border-primary" : "border";
                        <button type="button" class="p-0 rounded-3 overflow-hidden bg-white @activeThumb"
                                data-bs-target="#partGallery" data-bs-slide-to="@i" aria-label="Fotoğraf @i"
                                style="width:88px; height:88px;">
                            <img src="@slides[i]" alt="thumb" style="width:100%; height:100%; object-fit:cover;" />
                        </button>
                    }
                </div>
                <div class="flex-grow-1">
                    <div id="partGallery" class="carousel slide">
                        <div class="carousel-inner rounded-4 border overflow-hidden" style="min-height:320px;">
                            @for (int i = 0; i < slides.Count; i++)
                            {
                                var active = i == 0 ? "active" : "";
                                <div class="carousel-item @active">
                                    <img src="@slides[i]" class="d-block w-100" alt="@Model.Name" style="object-fit:cover; height:360px;">
                                </div>
                            }
                        </div>
                        @if (slides.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#partGallery" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Önceki</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#partGallery" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Sonraki</span>
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <div class="text-secondary small">@Model.Brand</div>
                    <h2 class="fw-bold mb-1">@Model.Name</h2>
                    <div class="text-secondary small">@Model.Category</div>
                    <div class="mt-1">
                        <span class="badge bg-light text-dark border">
                            Durum: @(string.IsNullOrWhiteSpace(Model.Condition) ? "Belirtilmemiş" : Model.Condition)
                        </span>
                    </div>
                    @if (compat.Count > 0)
                    {
                        <div class="text-secondary small mt-1">Uyumluluk:</div>
                        <ul class="text-secondary small mb-0 ps-3">
                            @foreach (var v in compat)
                            {
                                var sy = v!.StartYear ?? v.Year;
                                var ey = v.EndYear ?? v.Year;
                                var yearText = sy == ey ? sy.ToString() : $"{sy}-{ey}";
                                <li>@v.Brand @v.Model (@yearText)</li>
                            }
                        </ul>
                    }
                    else if (Model.Vehicle != null)
                    {
                        var sy = Model.Vehicle.StartYear ?? Model.Vehicle.Year;
                        var ey = Model.Vehicle.EndYear ?? Model.Vehicle.Year;
                        var yearText = sy == ey ? sy.ToString() : $"{sy}-{ey}";
                        <div class="text-secondary small mt-1">
                            Uyumluluk: @Model.Vehicle.Brand @Model.Vehicle.Model (@yearText)
                        </div>
                    }
                    @if (Model.Seller != null)
                    {
                        <div class="text-secondary small mt-2">
                            Satıcı:
                            <a asp-controller="Parts" asp-action="Index" asp-route-sellerId="@Model.SellerId">
                                @Model.Seller.FullName
                            </a>
                        </div>
                    }
                </div>
                <span class="badge @(Model.Stock <= 0 ? "text-bg-danger" : Model.Stock <= 3 ? "text-bg-warning" : "text-bg-success")">
                    @(Model.Stock <= 0 ? "Tükendi" : Model.Stock <= 3 ? "Az" : "Stokta")
                </span>
            </div>

            <div class="fs-3 fw-bold mb-1">@Model.Price.ToString("C0")</div>
            @if (reviews.Count > 0)
            {
                <div class="mb-2 text-warning small d-flex align-items-center gap-1">
                    @for (int s = 1; s <= 5; s++)
                    {
                        var cls = s <= Math.Round(avgRating) ? "bi-star-fill" : "bi-star";
                        <i class="bi @cls"></i>
                    }
                    <span class="text-secondary">(@reviews.Count)</span>
                </div>
            }

            <form asp-controller="Cart" asp-action="Add" method="post" class="d-flex gap-2 align-items-center">
                @Html.AntiForgeryToken()
                <input type="hidden" name="partId" value="@Model.Id" />
                <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                <label class="text-secondary small mb-0">Adet</label>
                <input type="number" name="quantity" value="1" min="1" max="99" class="form-control" style="width:96px;" />
                <button type="submit" class="btn btn-accent" @(Model.Stock <= 0 ? "disabled" : "")>
                    <i class="bi bi-bag-plus me-1"></i>Sepete Ekle
                </button>
            </form>

            <div class="mt-3 text-secondary small">
                Stok: @Model.Stock
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.Description))
    {
        <div class="mt-4">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="fw-semibold mb-2">Açıklama</h6>
                    <div class="text-secondary" style="white-space: pre-line;">@Model.Description</div>
                </div>
            </div>
        </div>
    }

    <div class="mt-4">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Sorular & Yanıtlar</h5>
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <form asp-action="AskQuestion" asp-controller="Parts" method="post" class="mb-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="partId" value="@Model.Id" />
                        <div class="row g-2">
                            <div class="col-md-10">
                                <textarea name="question" class="form-control" rows="2" placeholder="Satıcıya sorun..."></textarea>
                            </div>
                            <div class="col-md-2 d-grid">
                                <button class="btn btn-accent" type="submit">Gönder</button>
                            </div>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-info mb-3">Soru sormak için lütfen giriş yapın.</div>
                }

                <div class="list-group list-group-flush">
                    @foreach (var q in questions)
                    {
                        var asker = string.IsNullOrWhiteSpace(q.User?.FullName) ? "Kullanıcı" : q.User!.FullName;
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <div class="fw-semibold">@asker</div>
                                <div class="text-secondary small">@q.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
                            </div>
                            <div>@q.Question</div>
                            @if (!string.IsNullOrWhiteSpace(q.Answer))
                            {
                                <div class="mt-2 p-2 rounded bg-light">
                                    <div class="small text-secondary">Satıcı yanıtı</div>
                                    <div>@q.Answer</div>
                                </div>
                            }
                        </div>
                    }
                    @if (questions.Count == 0)
                    {
                        <div class="text-secondary">Bu ürün için henüz soru yok.</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Değerlendirmeler</h5>
                <style>
                    .rating-input {
                        display: inline-flex;
                        flex-direction: row-reverse;
                        gap: 4px;
                    }
                    .rating-input input {
                        display: none;
                    }
                    .rating-input label {
                        cursor: pointer;
                        position: relative;
                        width: 1.4rem;
                        height: 1.4rem;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .rating-input .star-empty {
                        color: #cbd5e1;
                    }
                    .rating-input .star-full {
                        color: #f59e0b;
                        position: absolute;
                        inset: 0;
                        opacity: 0;
                    }
                    .rating-input label:hover .star-full,
                    .rating-input label:hover ~ label .star-full,
                    .rating-input input:checked ~ label .star-full {
                        opacity: 1;
                    }
                    .rating-input label:hover .star-empty,
                    .rating-input label:hover ~ label .star-empty,
                    .rating-input input:checked ~ label .star-empty {
                        opacity: 0;
                    }
                    .rating-input input:focus + label {
                        outline: 2px solid #93c5fd;
                        outline-offset: 2px;
                        border-radius: 6px;
                    }
                </style>
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <form asp-action="AddReview" asp-controller="Parts" method="post" class="mb-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="partId" value="@Model.Id" />
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label">Puan</label>
                                <div class="rating-input" role="radiogroup" aria-label="Puan">
                                    @for (int r = 5; r >= 1; r--)
                                    {
                                        var id = $"rating_{r}";
                                        <input type="radio" name="rating" id="@id" value="@r" @(r == 5 ? "required" : "") />
                                        <label for="@id" title="@r">
                                            <i class="bi bi-star star-empty"></i>
                                            <i class="bi bi-star-fill star-full"></i>
                                        </label>
                                    }
                                </div>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Yorum (opsiyonel)</label>
                                <textarea name="comment" class="form-control" rows="2" placeholder="Deneyiminizi paylaşın..."></textarea>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-accent" type="submit">Gönder</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-info mb-3">Değerlendirme yapmak için lütfen giriş yapın.</div>
                }

                <div class="list-group list-group-flush">
                    @foreach (var r in reviews)
                    {
                        var reviewer = string.IsNullOrWhiteSpace(r.User?.FullName) ? "Kullanıcı" : r.User!.FullName;
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <div class="fw-semibold">@reviewer</div>
                                <div class="text-secondary small">@r.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
                            </div>
                            <div class="text-warning small mb-1">
                                @for (int s = 1; s <= 5; s++)
                                {
                                    var cls = s <= r.Rating ? "bi-star-fill" : "bi-star";
                                    <i class="bi @cls"></i>
                                }
                            </div>
                            @if (!string.IsNullOrWhiteSpace(r.Comment))
                            {
                                <div style="white-space: pre-wrap;">@r.Comment</div>
                            }
                        </div>
                    }
                    @if (reviews.Count == 0)
                    {
                        <div class="text-secondary">Henüz değerlendirme yok.</div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (ViewBag.Similar is List<AutoPartsWeb.Models.Part> sim && sim.Count > 0)
    {
        <div class="mt-5">
            <h5 class="fw-bold mb-3">Benzer Ürünler</h5>
            <div class="row g-3">
                @foreach (var p in sim)
                {
                    var img = !string.IsNullOrWhiteSpace(p.ImageUrl)
                        ? p.ImageUrl
                        : p.PartImages?.OrderBy(pi => pi.SortOrder).FirstOrDefault()?.Url;
                    <div class="col-6 col-lg-3">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-body p-2">
                                <div class="ratio ratio-4x3 mb-2 rounded overflow-hidden">
                                    @if (!string.IsNullOrWhiteSpace(img))
                                    {
                                        <img src="@img" alt="@p.Name" style="object-fit: cover; width:100%; height:100%;" />
                                    }
                                    else
                                    {
                                        <div class="bg-light border rounded d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-secondary"></i>
                                        </div>
                                    }
                                </div>
                                <div class="fw-semibold small text-truncate">@p.Name</div>
                                <div class="text-secondary small">@p.Brand • @p.Category</div>
                                @if (similarReviewDict.TryGetValue(p.Id, out var info) && info.count > 0)
                                {
                                    <div class="small text-warning">
                                        @for (int s = 1; s <= 5; s++)
                                        {
                                            var cls = s <= Math.Round(info.avg) ? "bi-star-fill" : "bi-star";
                                            <i class="bi @cls"></i>
                                        }
                                        <span class="text-secondary">(@info.count)</span>
                                    </div>
                                }
                                <div class="fw-bold mt-1">@p.Price.ToString("C0")</div>
                                <a class="stretched-link" asp-controller="Parts" asp-action="Details" asp-route-id="@p.Id"></a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (ViewBag.Discover is List<AutoPartsWeb.Models.Part> explore && explore.Count > 0)
    {
        <div class="mt-4">
            <h5 class="fw-bold mb-3">Bunlara da göz at</h5>
            <div class="row g-3">
                @foreach (var p in explore)
                {
                    var img = !string.IsNullOrWhiteSpace(p.ImageUrl)
                        ? p.ImageUrl
                        : p.PartImages?.OrderBy(pi => pi.SortOrder).FirstOrDefault()?.Url;
                    <div class="col-6 col-lg-3">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-body p-2">
                                <div class="ratio ratio-4x3 mb-2 rounded overflow-hidden">
                                    @if (!string.IsNullOrWhiteSpace(img))
                                    {
                                        <img src="@img" alt="@p.Name" style="object-fit: cover; width:100%; height:100%;" />
                                    }
                                    else
                                    {
                                        <div class="bg-light border rounded d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-secondary"></i>
                                        </div>
                                    }
                                </div>
                                <div class="fw-semibold small text-truncate">@p.Name</div>
                                <div class="text-secondary small">@p.Brand • @p.Category</div>
                                @if (discoverReviewDict.TryGetValue(p.Id, out var info) && info.count > 0)
                                {
                                    <div class="small text-warning">
                                        @for (int s = 1; s <= 5; s++)
                                        {
                                            var cls = s <= Math.Round(info.avg) ? "bi-star-fill" : "bi-star";
                                            <i class="bi @cls"></i>
                                        }
                                        <span class="text-secondary">(@info.count)</span>
                                    </div>
                                }
                                <div class="fw-bold mt-1">@p.Price.ToString("C0")</div>
                                <a class="stretched-link" asp-controller="Parts" asp-action="Details" asp-route-id="@p.Id"></a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>
