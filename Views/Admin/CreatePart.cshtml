@model AutoPartsWeb.Models.Part
@{
    ViewData["Title"] = "Yeni Parça";
    Layout = "_AdminLayout";
    var categories = new List<SelectListItem>
    {
        new("Fren","Fren"),
        new("Motor","Motor"),
        new("Filtre","Filtre"),
        new("Süspansiyon","Süspansiyon"),
        new("Şanzıman","Şanzıman"),
        new("Elektrik","Elektrik"),
        new("Lastik","Lastik"),
        new("Jant","Jant"),
        new("Kaporta","Kaporta"),
        new("Aydınlatma","Aydınlatma"),
        new("Egzoz","Egzoz"),
        new("Soğutma","Soğutma"),
        new("Yakıt","Yakıt"),
        new("Direksiyon","Direksiyon"),
        new("İç Donanım","İç Donanım"),
        new("Dış Aksesuar","Dış Aksesuar")
    };
    var partCategories = ViewBag.PartCategories as List<string> ?? new List<string>();
    if (partCategories.Count > 0)
    {
        categories = partCategories.Select(c => new SelectListItem(c, c)).ToList();
    }
    var vehicles = (List<AutoPartsWeb.Models.Vehicle>)ViewBag.Vehicles;
    var partBrands = ViewBag.PartBrands as List<string> ?? new List<string>();
    var selectedBrand = (Model?.Brand ?? "").Trim();
    var selectedBrandIndex = partBrands.FindIndex(b => string.Equals(b, selectedBrand, System.StringComparison.OrdinalIgnoreCase));
    var customBrandChecked = selectedBrandIndex < 0;
    var brandDropdownLabel = selectedBrandIndex >= 0
        ? partBrands[selectedBrandIndex]
        : (string.IsNullOrWhiteSpace(selectedBrand) ? "Marka sec" : selectedBrand);
    var customBrandStyle = customBrandChecked ? "" : "display:none;";
}

<div class="container py-4">
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
            <h3 class="fw-bold mb-4">
                <i class="bi bi-plus-circle me-2"></i>Yeni Parça Ekle
            </h3>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success rounded-4">
                    <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
                </div>
            }

            <form asp-controller="Admin" asp-action="CreatePart" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="mb-3">
                    <label class="form-label">Parça Adı</label>
                    <input class="form-control" asp-for="Name" maxlength="80" placeholder="Örn: Debriyaj Seti" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Marka</label>
                    <div class="dropdown w-100">
                        <button class="form-control text-start dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="brandDropdownBtnCreate">
                            @brandDropdownLabel
                        </button>
                        <div class="dropdown-menu p-3 w-100" style="max-height: 280px; overflow:auto;">
                            <input class="form-control form-control-sm mb-2" type="search" placeholder="Marka ara..." oninput="filterBrandList('brand-list-create', this.value)" />
                            <div id="brand-list-create">
                                @if (partBrands.Count == 0)
                                {
                                    <div class="text-secondary small">Kayitli marka yok.</div>
                                }
                                else
                                {
                                    for (int i = 0; i < partBrands.Count; i++)
                                    {
                                        var brand = partBrands[i];
                                        var id = $"brand_{i}";
                                        var checkedAttr = i == selectedBrandIndex ? "checked" : "";
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="BrandChoice" id="@id" value="@brand" @checkedAttr />
                                            <label class="form-check-label" for="@id">@brand</label>
                                        </div>
                                    }
                                }
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="BrandChoice" id="brand_custom" value="__custom__" @(customBrandChecked ? "checked" : "") />
                                    <label class="form-check-label" for="brand_custom">Yeni marka</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">Listeden secin veya yeni marka girin.</div>
                    </div>
                    <input type="hidden" asp-for="Brand" id="brandValueCreate" />
                    <div class="mt-2" id="brandCustomWrapCreate" style="@customBrandStyle">
                        <input class="form-control" id="brandCustomInputCreate" value="@selectedBrand" placeholder="Orn: Valeo" />
                        <div class="form-text">Yeni marka yazin.</div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Kategori</label>
                        <select class="form-select" asp-for="Category" asp-items="categories" required>
                            <option value="" disabled selected>Seç</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Durum</label>
                        <select class="form-select" asp-for="Condition" required>
                            <option value="Sıfır">Sıfır</option>
                            <option value="Çıkma">Çıkma</option>
                            <option value="İkinci El">İkinci El</option>
                            <option value="Yenilenmiş">Yenilenmiş</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Uyumlu Araçlar</label>
                        <div class="dropdown w-100">
                            <button class="form-control text-start dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Araçları Seç
                            </button>
                            <div class="dropdown-menu p-3 w-100" style="max-height: 320px; overflow:auto;">
                                <input class="form-control form-control-sm mb-2" type="search" placeholder="Araç ara..." oninput="filterVehicles('vehicle-list-create', this.value)" />
                                <div id="vehicle-list-create">
                                    @for (int i = 0; i < vehicles.Count; i++)
                                    {
                                        var v = vehicles[i];
                                        var startYear = v.StartYear ?? v.Year;
                                        var endYear = v.EndYear ?? v.Year;
                                        var yearLabel = startYear == endYear ? startYear.ToString() : $"{startYear}-{endYear}";
                                        <div class="border rounded-3 p-2 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="vehicleIds" value="@v.Id" id="v_@v.Id">
                                                <label class="form-check-label small fw-semibold" for="v_@v.Id">
                                                @v.Brand @v.Model (@yearLabel) @(string.IsNullOrWhiteSpace(v.Engine) ? "" : $"- {v.Engine}")
                                                </label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="form-text">Birden fazla aracı seçebilirsiniz.</div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">Fiyat</label>
                        <input class="form-control" asp-for="Price" type="number" step="0.01" placeholder="Örn: 1990.50" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Stok</label>
                        <input class="form-control" asp-for="Stock" type="number" placeholder="Örn: 15" required />
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" asp-for="Description" rows="3" placeholder="Opsiyonel açıklama"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Görsel URL</label>
                    <input class="form-control" asp-for="ImageUrl" placeholder="https://.../resim.jpg" />
                    <div class="form-text">CDN/link ekleyin. (Opsiyonel)</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Görsel Yükle (Dosya)</label>
                    <input class="form-control" type="file" name="ImageFile" accept="image/webp" />
                    <div class="form-text">Sadece .webp dosyaları; dosya yüklerseniz URL yerine dosya kullanılır.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ek Fotoğraflar (Galeri)</label>
                    <input class="form-control" type="file" name="GalleryFiles" accept="image/webp" multiple />
                    <div class="form-text">Birden fazla fotoğraf seçebilirsiniz. Kapak görseli yukarıdaki alandan seçilir.</div>
                </div>

                <button class="btn btn-accent w-100 mt-4" type="submit">
                    <i class="bi bi-save me-2"></i>Kaydet
                </button>
            </form>

        </div>
    </div>
</div>

<script>
    function filterVehicles(containerId, term) {
        term = (term || "").toLowerCase();
        const items = document.querySelectorAll(`#${containerId} .border`);
        items.forEach(el => {
            const txt = el.innerText.toLowerCase();
            el.style.display = txt.indexOf(term) !== -1 ? "" : "none";
        });
    }

    function filterBrandList(listId, term) {
        term = (term || "").toLowerCase();
        const items = document.querySelectorAll(`#${listId} .form-check`);
        items.forEach(el => {
            const input = el.querySelector("input");
            if (input && input.value === "__custom__") {
                el.style.display = "";
                return;
            }
            const txt = el.innerText.toLowerCase();
            el.style.display = txt.indexOf(term) !== -1 ? "" : "none";
        });
    }

    function initBrandPicker(listId, hiddenId, customWrapId, customInputId, buttonId) {
        const list = document.getElementById(listId);
        const hiddenInput = document.getElementById(hiddenId);
        const customWrap = document.getElementById(customWrapId);
        const customInput = document.getElementById(customInputId);
        const button = document.getElementById(buttonId);
        if (!list || !hiddenInput || !customWrap || !customInput || !button) return;

        const radios = list.querySelectorAll("input[name='BrandChoice']");
        const setButton = (text) => {
            button.textContent = text && text.trim() ? text : "Marka sec";
        };
        const applySelection = (radio) => {
            if (!radio) return;
            if (radio.value && radio.value !== "__custom__") {
                hiddenInput.value = radio.value;
                customWrap.style.display = "none";
                customInput.required = false;
                setButton(radio.value);
            } else {
                customWrap.style.display = "";
                customInput.required = true;
                const value = (customInput.value || "").trim();
                hiddenInput.value = value;
                setButton(value || "Yeni marka");
            }
        };

        radios.forEach(radio => {
            radio.addEventListener("change", () => applySelection(radio));
        });

        customInput.addEventListener("input", () => {
            const customRadio = list.querySelector("input[name='BrandChoice'][value='__custom__']");
            if (customRadio && customRadio.checked) {
                const value = (customInput.value || "").trim();
                hiddenInput.value = value;
                setButton(value || "Yeni marka");
            }
        });

        const selected = list.querySelector("input[name='BrandChoice']:checked");
        applySelection(selected);
    }

    function initVehicleYearToggles(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const rows = container.querySelectorAll(".border");
        rows.forEach(row => {
            const checkbox = row.querySelector("input[type='checkbox'][name='vehicleIds']");
            const start = row.querySelector("input[name='startYears']");
            const end = row.querySelector("input[name='endYears']");
            if (!checkbox || !start || !end) return;

            const toggle = () => {
                const enabled = checkbox.checked;
                start.disabled = !enabled;
                end.disabled = !enabled;
            };

            checkbox.addEventListener("change", toggle);
            toggle();
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        initBrandPicker("brand-list-create", "brandValueCreate", "brandCustomWrapCreate", "brandCustomInputCreate", "brandDropdownBtnCreate");
        initVehicleYearToggles("vehicle-list-create");
    });
</script>

